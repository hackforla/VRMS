version: "3.8"

services:
  mongo:
    image: "mongo:latest"
    expose:
      - "27017"
    ports:
      - "27017:27017"
    networks:
      - gateway
  dbseed:
    build:
      context: ./mongo
      dockerfile: Dockerfile.dev
    volumes:
      - ./mongo:/srv/mongo
    depends_on:
      - mongo
    networks:
      - gateway

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
      target: api-development
    command: yarn run dev
    volumes:
      - ./backend:/srv/backend
      - backend_node_modules:/srv/backend/node_modules
    environment:
      DATABASE_HOST: mongo
    expose:
      - "4000"
    ports:
      - "4000:4000"
    depends_on: 
      - mongo
    restart: on-failure
    networks:
      - gateway

  client:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
      target: client-development
    command: yarn run start
    volumes:
      - ./client:/srv/client
      - client_node_modules:/srv/client/node_modules
    expose:
      - "3000"
    ports:
      - "3000:3000"
    environment:
      BACKEND_HOST: backend
      CHOKIDAR_USEPOLLING: "true"
    depends_on: 
      - backend
    stdin_open: true
    restart: on-failure
    networks:
      - gateway

  nginx:
    restart: always
    build:
      dockerfile: Dockerfile.nginx
      context: ./nginx
    ports:
      - "80:80"
    networks:
      - gateway
    depends_on:
      - client
      - backend

  mailhog:
    image: mailhog/mailhog
    ports:
      - 1025:1025 # smtp server
      - 4100:8025 # web ui
    depends_on:
      - client
      - backend
    networks:
      - gateway

networks:
  gateway: {}

volumes:
  client_node_modules:
  backend_node_modules:
